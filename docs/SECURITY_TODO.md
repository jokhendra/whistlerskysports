<!-- Security audit TODO list generated by assistant -->
# Security Audit — Actionable TODOs

Below is a prioritized checklist of security and quality tasks discovered during a code review. Mark items as completed as you make changes.

- [ ] **Critical — Remove committed secrets and rotate keys**
  - Files: `config/paypal.php`, repo history
  - Action: Remove default client IDs/secrets from `config/paypal.php`; load only from environment (`env()`);
  - Follow-up: Rotate any exposed PayPal keys immediately and revoke old credentials.

- [ ] **Critical — Fix open redirect(s)**
  - Files: `app/Http/Controllers/AuthController.php`, any controllers using `redirect($redirect)`
  - Action: Replace `return redirect($redirect)` with a safe redirect helper. Accept only internal routes/relative paths or map allowed named routes.
  - Suggested check: `if (Str::startsWith($redirect, '/') && !Str::startsWith($redirect, '//')) { return redirect($redirect); }`

- [ ] **Critical — Correct CSRF / signed-route misuse in booking flow**
  - Files: `app/Http/Controllers/BookingController.php`
  - Action: Remove incorrect `hasValidSignature()` conditional for POST; rely on Laravel CSRF middleware for form POSTs; use signed routes only for GET links and verify signatures there.

- [ ] **Critical — Harden payment processing and webhooks**
  - Files: `app/Http/Controllers/BookingController.php`, `app/Http/Controllers/CartController.php`, `app/Services/PayPalService.php`
  - Actions:
    - Verify amounts, currency, payer ID, and order reference match internal order before marking paid.
    - Implement idempotent processing (check if payment/order already processed).
    - Verify PayPal webhook signatures on webhook endpoints; do not trust payloads blindly.
    - Prefer Laravel `Http::` client; if using cURL, ensure SSL verification and explicit timeouts.

- [ ] **High — Apply rate limiting to custom login endpoints**
  - Files: `routes/web.php`, `app/Http/Controllers/AuthController.php`
  - Action: Add throttle middleware to `POST /login` route (e.g., `->middleware('throttle:5,1')`) or integrate with Fortify's rate limiter.

- [ ] **High — Stop logging PII and sensitive provider payloads**
  - Files: multiple (`BookingController`, `PayPalService`, `ReviewController`, etc.)
  - Action: Remove or redact sensitive fields from logs (emails, full provider responses, tokens, full request payloads). Keep only debugging identifiers.

- [ ] **High — Strengthen file upload validation**
  - Files: `app/Http/Controllers/ReviewController.php`, `app/Http/Controllers/Admin/*ImageController.php`, `app/Http/Controllers/Admin/GalleryController.php`
  - Actions:
    - Validate file contents (use image libraries for images) in addition to mime/extension checks.
    - Enforce max file size and use streaming storage APIs (`putFile`, `putFileAs`).
    - Ensure uploaded files cannot be executed on server and scanned for malware if possible.

- [ ] **High — Audit Blade templates for XSS / unescaped outputs**
  - Files: `resources/views/**` (search for `{!!` and any raw echo of user content)
  - Action: Replace unsafe `{!! $var !!}` with escaped `{{ $var }}` or sanitize HTML server-side using a whitelist (e.g., HTMLPurifier) if HTML is required.

- [ ] **Medium — Audit mass-assignment on models**
  - Files: All models (`app/Models/*`)
  - Action: Ensure `protected $fillable` or `protected $guarded` is set correctly to prevent unexpected mass assignment. Add tests for critical models (User, Payment, Booking, Order).

- [ ] **Medium — Validate S3 path handling before deletion**
  - Files: `app/Http/Controllers/Admin/ProductImageController.php`, other S3-delete usages
  - Action: Validate that paths to delete begin with allowed prefixes (e.g., `products/`, `blog/`) to avoid accidental deletions.

- [ ] **Medium — Replace raw cURL with Laravel HTTP client and enforce SSL**
  - Files: `app/Services/PayPalService.php`
  - Action: Use `Illuminate\Support\Facades\Http` with configured timeouts, retries, and TLS verification. Respect `config('paypal.validate_ssl')`.

- [ ] **Medium — Ensure admin-only actions are protected**
  - Files: `app/Http/Controllers/Admin/*`, `routes/web.php`
  - Action: Verify routes for admin controllers are behind proper middleware and cannot be reached by non-admins.

- [ ] **Low — Sanitize filenames and avoid memory spikes on uploads**
  - Files: upload controllers
  - Action: Use streamed reads and do not `file_get_contents()` large files into memory. Generate safe filenames (avoid client-provided names).

- [ ] **Low — Security headers & cookie flags**
  - Files: `config/session.php`, web server config
  - Action: Ensure `session.cookie_secure = true`, `session.same_site = 'lax'` or stricter, enable HSTS, CSP, X-Frame-Options, and X-Content-Type-Options in production.

- [ ] **Low — CI & automated scanning**
  - Action: Add secret scanning (gitleaks/truffleHog), dependency scanning (Snyk/OSS), and static analysis to CI pipeline.

Notes / How to mark done
- For each item, create a branch, implement changes, add tests if applicable, open PR with the issue number, and include a short CHANGELOG entry.
- If a secret was committed, rotate it, remove from history (use `git filter-repo` or `bfg`), and document rotation steps in the PR.

Useful quick commands
- Locate raw redirects: `rg "redirect\([\$a-zA-Z_]+redirect" -n`
- Find raw Blade unescaped: `rg "\{!!" -n resources/views`
- Find secrets committed: run a secret scanner in CI or locally: `gitleaks --path=. --report=gitleaks-report.json`

If you want, I can open PRs for the top 3 critical items and add test coverage for payment flows.


